<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Reportespiolis</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">

    <script src="./js/plotly-latest.min.js"></script>

    <style>
        :root {
            --color-nivel: #3498db;
            --color-rebalse: #d3a53c;
                    }
    </style>
</head>

<body style="margin: 0; padding: 0;">
    
    <div id="barrasup" style="background-color: #000000; color: #ffffff; padding: 6px 20px; display: flex; justify-content: space-between; align-items: center; font-family:consolas, monospace; font-size: 12px;">
    <span style="color: white;">Desarrollado por Comunicaciones</span>
    <span style="color: white;">Servicoop</span>
    </div>
    <h1 style="text-align: center; font-family: 'Consolas';">REPORTE HORARIO</h1>
    <div style="text-align: center; font-size: 16px; font-family: 'consolas';"> última actualización: <!-- ESTAMPATIEMPO --></div>
    <div>
        <table
            style="margin: 25px auto; border-collapse: collapse; border: 1px solid #eee; border-bottom: 2px solid #3498db; box-shadow: 0px 0px 20px rgba(0, 0, 0, 0.10), 0px 10px 20px rgba(0, 0, 0, 0.05), 0px 20px 20px rgba(0, 0, 0, 0.05), 0px 30px 20px rgba(0, 0, 0, 0.05); font-family: 'consolas';">
            <thead>
                <tr>
                    <th
                        style="color: #000000; border: 1px solid #bebebe; padding: 12px 36px; border-collapse: collapse; text-align: center; background: #3498db; color: #fff; font-size: 16px;">
                        Sitio </th>
                    <th
                        style="color: #000000; border: 1px solid #bebebe; padding: 12px 12px; border-collapse: collapse; text-align: center; background: #3498db; color: #fff; font-size: 16px;">
                        <!-- HEADER_0 --> <button id="copiar">Copiar</button> </th>
                    <th
                        style="color: #000000; border: 1px solid #bebebe; padding: 12px 12px; border-collapse: collapse; text-align: center; background: #3498db; color: #fff; font-size: 16px;">
                        <!-- HEADER_1 --></th>
                    <th
                        style="color: #000000; border: 1px solid #bebebe; padding: 12px 12px; border-collapse: collapse; text-align: center; background: #3498db; color: #fff; font-size: 16px;">
                        <!-- HEADER_2 --></th>
                    <th
                        style="color: #000000; border: 1px solid #bebebe; padding: 12px 12px; border-collapse: collapse; text-align: center; background: #3498db; color: #fff; font-size: 16px;">
                        <!-- HEADER_3 --></th>
                </tr>
            </thead>
            <tbody>
                <tr style="font-family: 'consolas';">
                    <td
                        style="text-align: left; color: #000000; border: 1px solid #bebebe; padding: 12px 36px; border-collapse: collapse;"></td>
                    <td
                        style="text-align: center; color: #000000; border: 1px solid #bebebe; padding: 12px 12px; border-collapse: collapse;"></td>
                    <td 
                        style="text-align: center; color: #000000; border: 1px solid #bebebe; padding: 12px 12px; border-collapse: collapse;"></td>
                    <td 
                        style="text-align: center; color: #000000; border: 1px solid #bebebe; padding: 12px 12px; border-collapse: collapse;"></td>
                    <td 
                        style="text-align: center; color: #000000; border: 1px solid #bebebe; padding: 12px 12px; border-collapse: collapse;"></td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Div donde se renderizará el gráfico -->    
    <div id="grafBarras" style="width: 100%; margin: 50px 0px 0px 0px;"></div>
    <div id="TituloVolumenes" style="text-align: center; font-family: 'consolas'; margin: 25px 0px; font-size: 18px;">Volúmenes y Porcentajes de agua en m3</div>

    <div style="display: flex; justify-content: center; align-items: center; flex-wrap: wrap;">
        <div id="grafPieMdy" style="margin: 25px 0px;"></div>
        <!-- <div id="grafPieTw" style="margin: 25px 0px;"></div> -->
    </div>
    
    <div id="grafLineas" style="margin: 50px 0px ;"></div>

    <script>
        document.getElementById('copiar').addEventListener('click', function () {

            let textToCopy = '';
            let filas = document.querySelector("tbody").children

            for (let i = 0; i < filas.length; i++) {
                textToCopy += filas[i].childNodes[1].innerText + "," + filas[i].childNodes[3].innerText + '\n';
            }
            textToCopy = textToCopy.trim()

            navigator.clipboard.writeText(textToCopy).then(() => {
                alert('Texto copiado al portapapeles');
            }).catch(err => {
                console.log('Error al copiar el texto: ', err);
            });
        });
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            barras()
            pieMdy()
            //pieTw()
            lineas()
        })
    </script>

    <script>
        // Función para calcular porcentaje de nivel respecto al maxoperativo
        function calcularPorcentaje(nivel, maxoperativo) {
            if (maxoperativo === null || maxoperativo === undefined || maxoperativo === 0) {
                return null; // Sitio sin maxoperativo definido
            }
            var porcentaje = (nivel / maxoperativo) * 100;
            return Math.min(porcentaje, 100); // Limitar a máximo 100%
        }

        // Función para obtener maxoperativo por sitio (basado en sitioDAO.js)
        function getMaxoperativo(sitio) {
            const maxoperativos = {
                'Toma(Rio)': 4.0,    // Usar rebalse en lugar de null
                'Toma(Des.)': 3.0,   // Usar rebalse en lugar de null
                'P.Pot': 3.0,        // Usar rebalse en lugar de null
                'L.Maria': 4.45,
                'KM11': 4.4,
                'R6000': 3.5,
                'B.OESTE(1K)': 3.33,
                'B.SAN MIGUEL': 3.05,
                'NUEVA CHUBUT': 3.4,
                'B.PUJOL': 2.06,
                'Doradillo': 2.89,
                'Cota45': 3.09
            };
            return maxoperativos[sitio];
        }

        function barras() {

            /* ********************************************
            *********** GRAFICO BARRAS PORCENTUALES ***********
            ******************************************** */

            var sitios = [<!-- SITIOS -->]
            var niveles = [<!-- NIVELES -->]

            // Calcular porcentajes y preparar datos
            var porcentajes = [];
            var maxoperativos = [];
            var colores = [];
            var textos = [];
            var textos_restantes = [];
            var colores_restantes = [];

            for (var i = 0; i < sitios.length; i++) {
                var maxop = getMaxoperativo(sitios[i]);
                maxoperativos.push(maxop);

                // Todos los sitios ahora tienen maxoperativo (usando rebalse para los que no tenían)
                var porc = calcularPorcentaje(niveles[i], maxop);
                porcentajes.push(porc);

                // Determinar color basado en si excede el maxoperativo
                if (niveles[i] > maxop) {
                    colores.push('#ff6b6b'); // Rojo para advertencia
                    textos.push('100%+');
                } else {
                    colores.push(getComputedStyle(document.documentElement).getPropertyValue('--color-nivel').trim());
                    textos.push(porc.toFixed(1) + '%');
                }

                // Calcular espacio restante hasta 100%
                var restante = 100 - porc;
                textos_restantes.push(restante > 0.1 ? restante.toFixed(1) + '%' : '');
                colores_restantes.push(getComputedStyle(document.documentElement).getPropertyValue('--color-rebalse').trim());
            }

            // Trace para niveles actuales (porcentuales)
            var traceNiveles = {
                x: sitios,
                y: porcentajes,
                name: 'Nivel Actual',
                type: 'bar',
                marker: {
                    color: colores,
                    opacity: 1.0  // Opacidad original
                },
                text: textos,
                textposition: 'auto',
                hoverinfo: 'text',
                hovertext: sitios.map((sitio, i) => {
                    var porc = porcentajes[i];
                    var estado = niveles[i] > maxoperativos[i] ? '¡EXCEDE!' : 'Normal';
                    var tipoRef = (sitio === 'Toma(Rio)' || sitio === 'Toma(Des.)' || sitio === 'P.Pot') ? 'Rebalse' : 'Max Op';
                    return `${sitio}<br>Nivel: ${niveles[i].toFixed(2)}m<br>${tipoRef}: ${maxoperativos[i]}m<br>Porcentaje: ${porc.toFixed(1)}%<br>Estado: ${estado}`;
                })
            };

            // Trace para espacio restante hasta 100%
            var traceRestante = {
                x: sitios,
                y: porcentajes.map(p => 100 - p),
                name: 'Espacio Disponible',
                type: 'bar',
                marker: {
                    color: colores_restantes,
                    opacity: 0.3  // Opacidad original
                },
                text: textos_restantes,
                textposition: 'auto',
                hoverinfo: 'skip',
                showlegend: true
            };

            var datosBarra = [traceNiveles, traceRestante];

            // Configurar el diseño del gráfico porcentual
            var layout = {
                barmode: 'stack',
                title: 'Niveles actuales (% del máximo operativo)',

                xaxis: {
                    title: ''
                },
                yaxis: {
                    title: 'Porcentaje del Máximo Operativo [%]',
                    range: [0, 100],
                    tickformat: '.0f',
                    dtick: 10,
                    ticksuffix: '%'
                },
                autosize: true,
                font: {
                    family: 'consolas',
                    size: 12
                },
                legend: {
                    orientation: 'h',
                    y: -0.2
                }
            };
            var configBarras = { responsive: true};
            Plotly.newPlot('grafBarras', datosBarra, layout, configBarras);
        }
    </script>

    <script>
        function pieMdy(){

            /* ********************************************
            *********** GRAFICO TORTA ***********
            ******************************************** */
            
            var data = [{
                "type": "sunburst",
                [tracePieMdy]
                outsidetextfont: {size: 20, color: "#377eb8"},
                "leaf": {opacity: 0.6},
                "marker": {line: {width: 2}},
                "branchvalues": 'total', 
                hovertemplate: "<b>%{label}</b><br>%{value:.2f} m3<extra></extra>",
                marker: {
                    colors: ['rgba(211, 165, 60, 0.3)', "", getComputedStyle(document.documentElement).getPropertyValue('--color-nivel').trim()]
                },
                textinfo: "label+percent entry",
            }];

            var layout = {
                margin: {l: 0, r: 0, b: 25, t: 25},
                autosize: true,
                title: {
                    text: 'Puerto Madryn',
                    font: {
                        family: 'consolas',
                        size: 17
                    },   
                },
                font: {
                    family: 'consolas',  // Cambia la fuente para el gráfico en general
                    size: 12,
                    color: 'black'  // Cambia el color del texto general
                }   
            };

            var configPie = {responsive: true};
            Plotly.newPlot('grafPieMdy', data, layout, configPie);
        }
    </script>

    <script>
        function pieTw(){

            /* ********************************************
            *********** GRAFICO TORTA ***********
            ******************************************** */
            
            var data = [{
                "type": "sunburst",
                [tracePieTw]
                outsidetextfont: {size: 20, color: "#377eb8"},
                "leaf": {opacity: 0.6},
                "marker": {line: {width: 2}},
                "branchvalues": 'total', 
                hovertemplate: "<b>%{label}</b><br>%{value:.2f} m3<extra></extra>",
                marker: {
                    colors: ['rgba(211, 165, 60, 0.3)', "", getComputedStyle(document.documentElement).getPropertyValue('--color-nivel').trim()]
                },
                textinfo: "label+percent entry",
            }];

            var layout = {
                margin: {l: 0, r: 0, b: 0, t: 25},
                autosize: true,
                title: {
                    text: 'Trelew',
                    font: {
                        family: 'consolas',
                        size: 17
                    },   
                },
                font: {
                    family: 'consolas',  // Cambia la fuente para el gráfico en general
                    size: 12,
                    color: 'black'  // Cambia el color del texto general
                }   
            };

            var configPie = {responsive: true};
            Plotly.newPlot('grafPieTw', data, layout, configPie);
        }
    </script>

    <script>
        function lineas() {

            /* ********************************************
            *********** GRAFICO LINEAS ***********
            ******************************************** */

            [trace]

            var configLineas = {responsive: true};
            Plotly.newPlot('grafLineas', datosLinea, layout, configLineas);
        }
    </script>
</body>
</html>
